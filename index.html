<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆìŒAI - ì¹˜ë§¤ í™˜ìë¥¼ ìœ„í•œ AI ëŒ€í™” ì„œë¹„ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 95%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .icons {
            display: flex;
            gap: 10px;
        }

        .icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
        }

        .message.ai .message-bubble {
            background: #e3f2fd;
            color: #1565c0;
        }

        .message.user .message-bubble {
            background: #4caf50;
            color: white;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .ai-avatar {
            background: #2196f3;
            color: white;
        }

        .user-avatar {
            background: #4caf50;
            color: white;
        }

        .status {
            padding: 15px 20px;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            margin: 10px 20px;
            border-radius: 0 8px 8px 0;
        }

        .controls {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .text-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .text-input:focus {
            border-color: #2196f3;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1976d2;
            transform: translateY(-2px);
        }

        .btn-voice {
            background: #f44336;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
        }

        .btn-voice.recording {
            background: #ff1744;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .emotion-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .emotion-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
        }

        .emotion-indicator.warning {
            background: #ff9800;
        }

        .emotion-indicator.danger {
            background: #f44336;
        }

        .user-info {
            background: #e8f5e8;
            padding: 15px;
            margin: 10px 20px;
            border-radius: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .settings-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- ì´ˆê¸° ì„¤ì • ëª¨ë‹¬ -->
    <div class="setup-modal" id="setupModal">
        <div class="modal-content">
            <h2>í™˜ì ì •ë³´ ì…ë ¥</h2>
            <form id="patientForm">
                <div class="form-group">
                    <label for="patientName">ì´ë¦„:</label>
                    <input type="text" id="patientName" required>
                </div>
                
                <div class="form-group">
                    <label for="patientAge">ë‚˜ì´:</label>
                    <input type="number" id="patientAge" min="1" max="120" required>
                </div>

                <div class="form-group">
                    <label for="patientGender">ì„±ë³„:</label>
                    <select id="patientGender" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                        <option value="ì—¬ì„±">ì—¬ì„±</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="hometown">ê³ í–¥/ì¶œìƒì§€:</label>
                    <input type="text" id="hometown" placeholder="ì˜ˆ: ë¶€ì‚°ê´‘ì—­ì‹œ">
                </div>

                <div class="form-group">
                    <label for="job">ê³¼ê±° ì§ì—…:</label>
                    <input type="text" id="job" placeholder="ì˜ˆ: êµì‚¬, ë†ë¶€, ì‚¬ì—…ê°€">
                </div>

                <div class="form-group">
                    <label for="family">ê°€ì¡± ê´€ê³„:</label>
                    <textarea id="family" placeholder="ì˜ˆ: ì•„ë“¤ ê¹€ì² ìˆ˜(45ì„¸), ë©°ëŠë¦¬ ì´ì˜í¬(42ì„¸), ì†ì ê¹€ë¯¼ìˆ˜(15ì„¸)"></textarea>
                </div>

                <div class="form-group">
                    <label for="hobbies">ì·¨ë¯¸/ê´€ì‹¬ì‚¬:</label>
                    <textarea id="hobbies" placeholder="ì˜ˆ: íŠ¸ë¡œíŠ¸ ìŒì•…, ì›ì˜ˆ, ì‚°ì±…, ìš”ë¦¬"></textarea>
                </div>

                <div class="form-group">
                    <label for="memories">ì£¼ìš” ê¸°ì–µ/ì¶”ì–µ:</label>
                    <textarea id="memories" placeholder="ì˜ˆ: ë¶€ì‚°ì—ì„œ íƒœì–´ë‚¨, êµì‚¬ë¡œ 30ë…„ ê·¼ë¬´, 3ë‚¨ë§¤ í‚¤ì›€"></textarea>
                </div>

                <div class="form-group">
                    <label for="condition">ê±´ê°• ìƒíƒœ:</label>
                    <select id="condition">
                        <option value="ì •ìƒ">ì •ìƒ</option>
                        <option value="ê²½ë„ì¸ì§€ì¥ì• ">ê²½ë„ì¸ì§€ì¥ì• </option>
                        <option value="ì´ˆê¸°ì¹˜ë§¤">ì´ˆê¸°ì¹˜ë§¤</option>
                        <option value="ì¤‘ë“±ë„ì¹˜ë§¤">ì¤‘ë“±ë„ì¹˜ë§¤</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">ëŒ€í™” ì‹œì‘í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header" style="position: relative;">
            <button class="settings-btn" id="settingsBtn">ì„¤ì •</button>
            <h1>
                <div class="icons">
                    <div class="icon">ğŸ§ </div>
                    <div class="icon">ğŸ’™</div>
                    <div class="icon">ğŸ’¬</div>
                </div>
                ë§ˆìŒAI
            </h1>
            <p>ì¹˜ë§¤ í™˜ìë¥¼ ìœ„í•œ ë§ì¶¤í˜• AI ëŒ€í™” ì„œë¹„ìŠ¤</p>
        </div>

        <div class="user-info">
            <strong>ì‚¬ìš©ì:</strong> <span id="userName">-</span> | 
            <strong>ë‚˜ì´:</strong> <span id="userAge">-</span> | 
            <strong>ìƒíƒœ:</strong> <span id="userCondition">-</span>
        </div>

        <div class="status">
            <div class="emotion-status">
                <div class="emotion-indicator" id="emotionIndicator"></div>
                <span id="emotionStatus">ì •ì„œ ìƒíƒœ: ëŒ€ê¸° ì¤‘</span>
            </div>
            <div>ë§ˆì§€ë§‰ ëŒ€í™”: <span id="lastChat">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</span></div>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- ëŒ€í™”ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            AIê°€ ì‘ë‹µì„ ìƒì„±ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <div class="controls">
            <div class="input-group">
                <input type="text" class="text-input" id="textInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                <button class="btn btn-primary" id="sendBtn" disabled>ì „ì†¡</button>
                <button class="btn btn-voice" id="voiceBtn" title="ìŒì„±ìœ¼ë¡œ ë§í•˜ê¸°" disabled>ğŸ¤</button>
            </div>
            <div style="text-align: center; font-size: 14px; color: #666;">
                ë¨¼ì € í™˜ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ìŒì„± ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§ì”€í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <script>
        class MaeumAI {
            constructor() {
                this.isRecording = false;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.isSetupComplete = false;
                this.conversationHistory = [];
                this.userProfile = {};
                this.dangerKeywords = ["ì£½ê³ ì‹¶ë‹¤", "ìì‚´", "ì™¸ë¡œì›Œ", "ì•„íŒŒ", "ë„ì™€ì¤˜", "ë¬´ì„œì›Œ", "í˜ë“¤ì–´"];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupSpeechRecognition();
                this.showSetupModal();
                
                // í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì´ˆê¸°í™” (ë°ëª¨ ëª¨ë“œ)
                this.initializeTestScenarios();
            }

            setupEventListeners() {
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('textInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                document.getElementById('voiceBtn').addEventListener('click', () => this.toggleVoiceRecording());
                document.getElementById('patientForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
                document.getElementById('settingsBtn').addEventListener('click', () => this.showSetupModal());
            }

            showSetupModal() {
                document.getElementById('setupModal').classList.remove('hidden');
                if (this.userProfile.name) {
                    // ê¸°ì¡´ ì •ë³´ê°€ ìˆìœ¼ë©´ í¼ì— ì±„ì›Œë„£ê¸°
                    document.getElementById('patientName').value = this.userProfile.name || '';
                    document.getElementById('patientAge').value = this.userProfile.age || '';
                    document.getElementById('patientGender').value = this.userProfile.gender || '';
                    document.getElementById('hometown').value = this.userProfile.hometown || '';
                    document.getElementById('job').value = this.userProfile.job || '';
                    document.getElementById('family').value = this.userProfile.family || '';
                    document.getElementById('hobbies').value = this.userProfile.hobbies || '';
                    document.getElementById('memories').value = this.userProfile.memories || '';
                    document.getElementById('condition').value = this.userProfile.condition || '';
                }
            }

            handleFormSubmit(e) {
                e.preventDefault();
                
                this.userProfile = {
                    name: document.getElementById('patientName').value,
                    age: parseInt(document.getElementById('patientAge').value),
                    gender: document.getElementById('patientGender').value,
                    hometown: document.getElementById('hometown').value,
                    job: document.getElementById('job').value,
                    family: document.getElementById('family').value,
                    hobbies: document.getElementById('hobbies').value,
                    memories: document.getElementById('memories').value,
                    condition: document.getElementById('condition').value
                };

                this.updateUserInfo();
                this.enableControls();
                document.getElementById('setupModal').classList.add('hidden');
                this.startConversation();
            }

            updateUserInfo() {
                document.getElementById('userName').textContent = this.userProfile.name;
                document.getElementById('userAge').textContent = this.userProfile.age + "ì„¸";
                document.getElementById('userCondition').textContent = this.userProfile.condition;
            }

            enableControls() {
                document.getElementById('textInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('voiceBtn').disabled = false;
                this.isSetupComplete = true;
            }

            startConversation() {
                const greeting = this.generatePersonalizedGreeting();
                this.addMessage(greeting, 'ai');
                this.speakResponse(greeting);
            }

            generatePersonalizedGreeting() {
                const greetings = [
                    `ì•ˆë…•í•˜ì„¸ìš”, ${this.userProfile.name}ë‹˜! ì˜¤ëŠ˜ë„ ê±´ê°•í•˜ê²Œ ì§€ë‚´ê³  ê³„ì‹ ê°€ìš”?`,
                    `${this.userProfile.name}ë‹˜, ë°˜ê°‘ìŠµë‹ˆë‹¤! ì˜¤ëŠ˜ ê¸°ë¶„ì€ ì–´ë– ì‹ ì§€ ê¶ê¸ˆí•´ìš”.`,
                    `${this.userProfile.name}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ${this.userProfile.hometown}ì€ ì–´ë–¤ ê³³ì¸ì§€ ì´ì•¼ê¸°í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?`
                ];
                
                if (this.userProfile.hobbies) {
                    greetings.push(`${this.userProfile.name}ë‹˜, ì˜¤ëŠ˜ë„ ${this.userProfile.hobbies.split(',')[0]}ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹ ê°€ìš”?`);
                }
                
                return greetings[Math.floor(Math.random() * greetings.length)];
            }

            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.lang = 'ko-KR';
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('textInput').value = transcript;
                        this.sendMessage();
                    };

                    this.recognition.onerror = (event) => {
                        console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                        this.stopRecording();
                    };

                    this.recognition.onend = () => {
                        this.stopRecording();
                    };
                }
            }

            toggleVoiceRecording() {
                if (!this.isSetupComplete) {
                    alert('ë¨¼ì € í™˜ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!this.recognition) {
                    alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            }

            startRecording() {
                this.isRecording = true;
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = 'ğŸ›‘';
                this.recognition.start();
            }

            stopRecording() {
                this.isRecording = false;
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'ğŸ¤';
                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            async sendMessage() {
                if (!this.isSetupComplete) {
                    alert('ë¨¼ì € í™˜ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const input = document.getElementById('textInput');
                const message = input.value.trim();
                if (!message) return;

                this.addMessage(message, 'user');
                this.conversationHistory.push({type: 'user', message: message, timestamp: new Date()});
                input.value = '';

                // ìœ„í—˜ ë°œí™” ê°ì§€
                this.checkDangerousContent(message);

                // ê°ì • ë¶„ì„
                this.analyzeEmotion(message);

                // AI ì‘ë‹µ ìƒì„±
                this.showLoading(true);
                const response = await this.generateAIResponse(message);
                this.showLoading(false);
                
                this.addMessage(response, 'ai');
                this.conversationHistory.push({type: 'ai', message: response, timestamp: new Date()});
                this.speakResponse(response);
                
                // ë§ˆì§€ë§‰ ëŒ€í™” ì‹œê°„ ì—…ë°ì´íŠ¸
                document.getElementById('lastChat').textContent = new Date().toLocaleTimeString('ko-KR');
            }

            addMessage(text, type) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const avatar = document.createElement('div');
                avatar.className = `avatar ${type}-avatar`;
                avatar.textContent = type === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            checkDangerousContent(message) {
                const foundDanger = this.dangerKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword.toLowerCase())
                );
                
                if (foundDanger) {
                    this.updateEmotionStatus('ìœ„í—˜', 'danger');
                    setTimeout(() => {
                        alert('âš ï¸ ìœ„í—˜ ë°œí™”ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´í˜¸ìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.');
                        console.log(`ì‘ê¸‰ìƒí™© ì•Œë¦¼ - í™˜ì: ${this.userProfile.name}, ë°œí™”: "${message}", ì‹œê°„: ${new Date()}`);
                    }, 1000);
                }
            }

            analyzeEmotion(message) {
                const positiveKeywords = ['ì¢‹ë‹¤', 'í–‰ë³µ', 'ê¸°ì˜ë‹¤', 'ì¦ê²ë‹¤', 'ê³ ë§™ë‹¤', 'ê°ì‚¬', 'ì›ƒìŒ'];
                const negativeKeywords = ['ìŠ¬í”„ë‹¤', 'ìš°ìš¸', 'í˜ë“¤ë‹¤', 'ì•„í”„ë‹¤', 'ì™¸ë¡­ë‹¤', 'ê±±ì •', 'ë¶ˆì•ˆ'];
                
                const hasPositive = positiveKeywords.some(keyword => message.includes(keyword));
                const hasNegative = negativeKeywords.some(keyword => message.includes(keyword));
                
                if (hasPositive) {
                    this.updateEmotionStatus('ê¸ì •', 'positive');
                } else if (hasNegative) {
                    this.updateEmotionStatus('ì£¼ì˜', 'warning');
                } else {
                    this.updateEmotionStatus('ì•ˆì •', 'stable');
                }
            }

            updateEmotionStatus(emotion, level) {
                const indicator = document.getElementById('emotionIndicator');
                const status = document.getElementById('emotionStatus');
                
                indicator.className = 'emotion-indicator';
                if (level === 'warning') indicator.classList.add('warning');
                if (level === 'danger') indicator.classList.add('danger');
                
                status.textContent = `ì •ì„œ ìƒíƒœ: ${emotion}`;
            }

            async generateAIResponse(userMessage) {
                // ëŒ€í™” ë§¥ë½ì„ ê³ ë ¤í•œ ë” ì§€ëŠ¥ì ì¸ ì‘ë‹µ ìƒì„±
                const context = this.buildConversationContext(userMessage);
                const response = this.selectContextualResponse(context, userMessage);
                
                // ì‘ë‹µ ì§€ì—° ì‹œë®¬ë ˆì´ì…˜
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                return response;
            }

            buildConversationContext(userMessage) {
                return {
                    userMessage: userMessage.toLowerCase(),
                    profile: this.userProfile,
                    history: this.conversationHistory.slice(-5), // ìµœê·¼ 5ê°œ ëŒ€í™”
                    keywords: this.extractKeywords(userMessage)
                };
            }

            extractKeywords(message) {
                const keywords = [];
                const lowerMessage = message.toLowerCase();
                
                // ê°€ì¡± ê´€ë ¨
                if (lowerMessage.includes('ì•„ë“¤') || lowerMessage.includes('ë©°ëŠë¦¬') || lowerMessage.includes('ì†ì') || lowerMessage.includes('ê°€ì¡±')) {
                    keywords.push('family');
                }
                
                // ê³¼ê±° ê´€ë ¨
                if (lowerMessage.includes('ì˜ˆì „') || lowerMessage.includes('ì˜›ë‚ ') || lowerMessage.includes('ì Šì—ˆì„ë•Œ') || lowerMessage.includes('ê¸°ì–µ')) {
                    keywords.push('memory');
                }
                
                // ê±´ê°• ê´€ë ¨
                if (lowerMessage.includes('ì•„í”„') || lowerMessage.includes('ë³‘ì›') || lowerMessage.includes('ì•½') || lowerMessage.includes('ê±´ê°•')) {
                    keywords.push('health');
                }
                
                // ì¼ìƒ ê´€ë ¨
                if (lowerMessage.includes('ì˜¤ëŠ˜') || lowerMessage.includes('ë‚ ì”¨') || lowerMessage.includes('ë°¥') || lowerMessage.includes('ì ')) {
                    keywords.push('daily');
                }
                
                // ì·¨ë¯¸ ê´€ë ¨
                if (lowerMessage.includes('ìŒì•…') || lowerMessage.includes('ì‚°ì±…') || lowerMessage.includes('í…”ë ˆë¹„ì „') || lowerMessage.includes('ì±…')) {
                    keywords.push('hobby');
                }
                
                return keywords;
            }

            selectContextualResponse(context, userMessage) {
                const responses = {
                    family: [
                        `${this.userProfile.family ? 'ê°€ì¡±ë¶„ë“¤' : 'ì‚¬ë‘í•˜ëŠ” ê°€ì¡±ë“¤'}ê³¼ í•¨ê»˜ ë³´ë‚¸ ì‹œê°„ë“¤ì´ ì†Œì¤‘í•˜ì‹œê² ì–´ìš”. ì–´ë–¤ ì¶”ì–µì´ ê°€ì¥ ê¸°ì–µì— ë‚¨ìœ¼ì‹œë‚˜ìš”?`,
                        `ê°€ì¡± ì´ì•¼ê¸°ë¥¼ ë“¤ìœ¼ë‹ˆ ë§ˆìŒì´ ë”°ëœ»í•´ì§‘ë‹ˆë‹¤. ê°€ì¡±ë¶„ë“¤ë„ ${this.userProfile.name}ë‹˜ì„ ë§ì´ ìƒê°í•˜ê³  ê³„ì‹¤ ê±°ì˜ˆìš”.`,
                        `${this.userProfile.family ? this.userProfile.family.split(',')[0] : 'ê°€ì¡±ë¶„'}ì€ ì–´ë–»ê²Œ ì§€ë‚´ê³  ê³„ì‹œë‚˜ìš”?`
                    ],
                    memory: [
                        `${this.userProfile.hometown ? this.userProfile.hometown + 'ì—ì„œì˜ ' : ''}ì–´ë¦° ì‹œì ˆ ì´ì•¼ê¸°ê°€ ê¶ê¸ˆí•´ìš”. ì–´ë–¤ ê¸°ì–µì´ ê°€ì¥ ìƒìƒí•˜ì‹ ê°€ìš”?`,
                        `${this.userProfile.job ? this.userProfile.job + ' ì¼ì„ í•˜ì‹¤ ë•Œ' : 'ì˜ˆì „ì—'} ê°€ì¥ ë³´ëŒì°¼ë˜ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?`,
                        `${this.userProfile.memories ? 'ë§ì”€í•´ì£¼ì‹  ì¶”ì–µë“¤ì„ ë“¤ìœ¼ë‹ˆ' : 'ê³¼ê±° ì´ì•¼ê¸°ë¥¼ ë“¤ìœ¼ë‹ˆ'} ì •ë§ ë§ì€ ê²½í—˜ì„ ìŒ“ìœ¼ì…¨ë„¤ìš”.`
                    ],
                    health: [
                        `ê±´ê°•ì´ ê°€ì¥ ì¤‘ìš”í•˜ì£ . ìš”ì¦˜ ëª¸ ìƒíƒœëŠ” ì–´ë– ì‹ ê°€ìš”? ë¶ˆí¸í•œ ê³³ì€ ì—†ìœ¼ì‹ ì§€ìš”?`,
                        `ê·œì¹™ì ì¸ ìƒí™œê³¼ ê°€ë²¼ìš´ ìš´ë™ì´ ë„ì›€ì´ ë  ê±°ì˜ˆìš”. ì‚°ì±…ì€ ìì£¼ ë‚˜ê°€ì‹œë‚˜ìš”?`,
                        `ì•½ì€ ê¼¬ë°•ê¼¬ë°• ì±™ê²¨ ë“œì‹œê³  ê³„ì‹ ê°€ìš”? ê±´ê°• ê´€ë¦¬ê°€ ì°¸ ì¤‘ìš”í•´ìš”.`
                    ],
                    daily: [
                        `ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë–»ê²Œ ë³´ë‚´ì…¨ë‚˜ìš”? íŠ¹ë³„í•œ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ìš”?`,
                        `ê·œì¹™ì ì¸ ìƒí™œ ë¦¬ë“¬ì´ ì¤‘ìš”í•´ìš”. ì ì€ ì˜ ì£¼ë¬´ì…¨ë‚˜ìš”?`,
                        `${this.userProfile.hobbies ? this.userProfile.hobbies.split(',')[0] + 'ëŠ” ìš”ì¦˜ë„ í•˜ê³  ê³„ì‹ ê°€ìš”?' : 'ì·¨ë¯¸ ìƒí™œì€ ì–´ë– ì‹ ê°€ìš”?'}`
                    ],
                    hobby: [
                        `${this.userProfile.hobbies ? this.userProfile.hobbies + ' ì¤‘ì—' : ''} ê°€ì¥ ì¢‹ì•„í•˜ì‹œëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?`,
                        `ìƒˆë¡œìš´ ì·¨ë¯¸ë¥¼ ì‹œì‘í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”? ê°„ë‹¨í•œ ê²ƒë¶€í„° ì²œì²œíˆìš”.`,
                        `ì·¨ë¯¸ í™œë™ì„ í•˜ì‹œë©´ ê¸°ë¶„ë„ ì¢‹ì•„ì§€ê³  ê±´ê°•ì—ë„ ë„ì›€ì´ ë  ê±°ì˜ˆìš”.`
                    ],
                    default: [
                        `${this.userProfile.name}ë‹˜ì˜ ë§ì”€ì„ ë“£ê³  ìˆì–´ìš”. ë” ìì„¸íˆ ì´ì•¼ê¸°í•´ì£¼ì‹œê² ì–´ìš”?`,
                        `ê·¸ë ‡êµ°ìš”. ${this.userProfile.name}ë‹˜ì€ ì–´ë–»ê²Œ ìƒê°í•˜ì„¸ìš”?`,
                        `í¥ë¯¸ë¡œìš´ ì´ì•¼ê¸°ë„¤ìš”. ë‹¤ë¥¸ ìƒê°ë„ ìˆìœ¼ì‹ ê°€ìš”?`,
                        `${this.userProfile.name}ë‹˜ê³¼ ëŒ€í™”í•˜ë‹ˆ ì¦ê±°ì›Œìš”. ì˜¤ëŠ˜ì€ ì–´ë–¤ í•˜ë£¨ì˜€ëŠ”ì§€ ê¶ê¸ˆí•´ìš”.`,
                        `ì²œì²œíˆ ë§ì”€í•´ì£¼ì„¸ìš”. ì œê°€ ì˜ ë“£ê³  ìˆì–´ìš”.`
                    ]
                };

                // í‚¤ì›Œë“œì— ë”°ë¼ ì‘ë‹µ ì¹´í…Œê³ ë¦¬ ì„ íƒ
                let selectedCategory = 'default';
                
                for (const keyword of context.keywords) {
                    if (responses[keyword]) {
                        selectedCategory = keyword;
                        break;
                    }
                }

                // íŠ¹ì • íŒ¨í„´ì— ëŒ€í•œ ë§ì¶¤ ì‘ë‹µ
                if (context.userMessage.includes('ì•ˆë…•') || context.userMessage.includes('ë°˜ê°€')) {
                    return `${this.userProfile.name}ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ë„ ë§Œë‚˜ëµ™ê²Œ ë˜ì–´ ê¸°ë»ìš”. ê¸°ë¶„ì€ ì–´ë– ì‹ ê°€ìš”?`;
                }
                
                if (context.userMessage.includes('ê³ ë§ˆ') || context.userMessage.includes('ê°ì‚¬')) {
                    return `${this.userProfile.name}ë‹˜, ì €ì•¼ë§ë¡œ ê³ ë§ˆì›Œìš”. ì´ë ‡ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆì–´ì„œ ì¦ê±°ì›Œìš”.`;
                }
                
                if (context.userMessage.includes('ë°°ê³ ') || context.userMessage.includes('ë°¥')) {
                    return `ë§›ìˆëŠ” ì‹ì‚¬í•˜ì„¸ìš”! ${this.userProfile.hobbies && this.userProfile.hobbies.includes('ìš”ë¦¬') ? 'ì§ì ‘ ìš”ë¦¬í•˜ì‹œëŠ” ê±¸ ì¢‹ì•„í•˜ì‹ ë‹¤ê³  í•˜ì…¨ì£ ?' : 'ì–´ë–¤ ìŒì‹ì„ ì¢‹ì•„í•˜ì„¸ìš”?'}`;
                }
                
                if (context.userMessage.includes('ì ') || context.userMessage.includes('í”¼ê³¤')) {
                    return `ì¶©ë¶„í•œ íœ´ì‹ì´ ì¤‘ìš”í•´ìš”. ë°¤ì—ëŠ” ì˜ ì£¼ë¬´ì‹œë‚˜ìš”? ë‚®ì ë„ ì ë‹¹íˆ ì£¼ë¬´ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ì•„ìš”.`;
                }

                // ì´ì „ ëŒ€í™”ì™€ì˜ ì—°ê²°ì„± ê³ ë ¤
                if (context.history.length > 0) {
                    const lastAIMessage = context.history.filter(h => h.type === 'ai').pop();
                    if (lastAIMessage && lastAIMessage.message.includes('ì–´ë–»ê²Œ')) {
                        // ì´ì „ì— ì§ˆë¬¸ì„ í–ˆë‹¤ë©´ ë” êµ¬ì²´ì ì¸ í›„ì† ì§ˆë¬¸
                        const followUps = [
                            `ë” ìì„¸íˆ ë§ì”€í•´ì£¼ì‹œë©´ ì¢‹ê² ì–´ìš”. ì–´ë–¤ ê¸°ë¶„ì´ì…¨ë‚˜ìš”?`,
                            `ê·¸ëŸ° ê²½í—˜ì„ í•˜ì…¨êµ°ìš”. ê·¸ë•Œ ì–´ë–¤ ìƒê°ì´ ë“œì…¨ì–´ìš”?`,
                            `${this.userProfile.name}ë‹˜ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ìœ¼ë‹ˆ ë§ì€ ê²ƒì„ ëŠë¼ê²Œ ë¼ìš”.`
                        ];
                        return followUps[Math.floor(Math.random() * followUps.length)];
                    }
                }

                const categoryResponses = responses[selectedCategory];
                return categoryResponses[Math.floor(Math.random() * categoryResponses.length)];
            }

            speakResponse(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 0.7; // ë” ì²œì²œíˆ
                    utterance.pitch = 1.1; // ë†’ì€ í†¤
                    utterance.volume = 0.9;
                    
                    // í•œêµ­ì–´ ìŒì„± ì„ íƒ
                    const voices = this.synthesis.getVoices();
                    const koreanVoice = voices.find(voice => 
                        voice.lang.includes('ko') || voice.name.includes('Korean')
                    );
                    if (koreanVoice) {
                        utterance.voice = koreanVoice;
                    }
                    
                    this.synthesis.speak(utterance);
                }
            }

            showLoading(show) {
                const loading = document.getElementById('loading');
                loading.style.display = show ? 'block' : 'none';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆìŒAI ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            const app = new MaeumAI();
            
            // ë¸Œë¼ìš°ì € ìŒì„± í•©ì„± ì¤€ë¹„
            if ('speechSynthesis' in window) {
                // ìŒì„± ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸°
                const loadVoices = () => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length === 0) {
                        setTimeout(loadVoices, 100);
                    }
                };
                loadVoices();
                
                // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì´ë²¤íŠ¸ë¡œ ìŒì„± ëª©ë¡ ë¡œë“œ ì™„ë£Œë¥¼ ì•Œë ¤ì¤Œ
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = loadVoices;
                }
            }
        });

        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ìŒì„± ì •ì§€
        window.addEventListener('beforeunload', () => {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>
